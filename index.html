<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <!-- iOS Game Optimized Viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />

  <title>Survival Scene</title>

  <!-- PWA Configuration -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-512.svg">

  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Game">
  <meta name="theme-color" content="#0f1115">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    /* iOS Game Optimizations */
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f1115;
      color: #eee;

      /* Fixed height prevents keyboard resize */
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;

      /* Disable iOS behaviors that interfere with games */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;

      /* Prevent pull-to-refresh */
      overscroll-behavior: none;

      /* Support safe areas (notch, home indicator) */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    body {
      touch-action: manipulation; /* Prevents double-tap zoom */
    }

    /* Console styles */
    #console-toggle {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1a1d23;
      border: 2px solid #333;
      color: #eee;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s;
    }
    #console-toggle:hover {
      background: #252831;
      border-color: #555;
    }

    #console-panel {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      width: 400px;
      max-width: calc(100vw - 40px);
      height: 300px;
      background: #1a1d23;
      border: 2px solid #333;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 999;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    #console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #252831;
      border-bottom: 1px solid #333;
      border-radius: 6px 6px 0 0;
    }

    #console-title {
      font-weight: bold;
      color: #eee;
    }

    #console-buttons {
      display: flex;
      gap: 8px;
    }

    #console-clear,
    #console-copy {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 11px;
    }
    #console-clear:hover,
    #console-copy:hover {
      color: #eee;
    }

    #console-output {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      color: #ccc;
      /* Make text selectable for copying */
      -webkit-user-select: text;
      user-select: text;
    }

    .console-message {
      margin-bottom: 4px;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .console-time {
      color: #666;
      margin-right: 6px;
    }

    .console-log {
      color: #ccc;
    }

    .console-warn {
      color: #f1c40f;
    }

    .console-error {
      color: #e74c3c;
    }

    #console-output::-webkit-scrollbar {
      width: 8px;
    }

    #console-output::-webkit-scrollbar-track {
      background: #1a1d23;
    }

    #console-output::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }

    #console-output::-webkit-scrollbar-thumb:hover {
      background: #444;
    }

    /* Reload button styles */
    #reload-button {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      left: calc(20px + env(safe-area-inset-left));
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e74c3c;
      border: 2px solid #c0392b;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s;
    }
    #reload-button.show {
      display: flex;
      animation: pulse 2s ease-in-out infinite;
    }
    #reload-button:hover {
      background: #c0392b;
      border-color: #a93226;
      transform: scale(1.05);
    }
    #reload-button:active {
      transform: scale(0.95);
    }
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
      }
      50% {
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
      }
    }
    #reload-button::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    #reload-button:hover::after {
      opacity: 1;
    }

    /* Game Over UI */
    #game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 2000;
    }
    #game-over-screen.show {
      display: flex;
    }
    #game-over-title {
      font-size: 64px;
      font-weight: bold;
      color: #e74c3c;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    #game-over-message {
      font-size: 18px;
      color: #ccc;
      margin-bottom: 30px;
      text-align: center;
      max-width: 80%;
    }
    #respawn-button {
      padding: 15px 40px;
      font-size: 20px;
      font-weight: bold;
      background: #27ae60;
      color: white;
      border: 3px solid #229954;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    #respawn-button:hover {
      background: #229954;
      border-color: #1e8449;
      transform: scale(1.05);
    }
    #respawn-button:active {
      transform: scale(0.95);
    }

    /* Needs bars UI - Thin design */
    #needs-display {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      left: calc(20px + env(safe-area-inset-left));
      background: rgba(26, 29, 35, 0.85);
      border: 2px solid #333;
      border-radius: 8px;
      padding: 10px;
      z-index: 100;
      min-width: 180px;
    }
    .need-bar-container {
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .need-bar-container:last-child {
      margin-bottom: 0;
    }
    .need-emoji {
      font-size: 16px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    .need-bar-bg {
      flex: 1;
      height: 8px;
      background: #1a1d23;
      border: 1px solid #333;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .need-bar-fill {
      height: 100%;
      transition: width 0.3s, background 0.3s;
      border-radius: 3px;
    }
    .need-bar-fill.hp {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
    }
    .need-bar-fill.food {
      background: linear-gradient(90deg, #f39c12, #e67e22);
    }
    .need-bar-fill.energy {
      background: linear-gradient(90deg, #f1c40f, #f39c12);
    }
    .need-bar-fill.warmth {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
    }

    /* Action Menu UI */
    #action-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 29, 35, 0.95);
      border: 3px solid #555;
      border-radius: 12px;
      padding: 20px;
      z-index: 500;
      display: none;
      flex-direction: column;
      min-width: 300px;
      max-width: 400px;
      max-height: 70vh;
    }
    #action-menu.show {
      display: flex;
    }
    #action-menu-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      color: #fff;
      text-align: center;
    }
    #action-menu-list {
      overflow-y: auto;
      max-height: 50vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .action-item {
      background: #1a1d23;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
      color: #eee;
      font-size: 14px;
      text-align: left;
    }
    .action-item:hover {
      background: #252831;
      border-color: #555;
      transform: translateX(4px);
    }
    .action-item:active {
      transform: scale(0.98);
    }
    #action-menu-close {
      margin-top: 12px;
      padding: 10px;
      background: #e74c3c;
      border: 2px solid #c0392b;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    #action-menu-close:hover {
      background: #c0392b;
    }

    /* Feedback Ticker UI - Shows last action result */
    #feedback-log {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 29, 35, 0.9);
      border: 2px solid #333;
      border-radius: 8px;
      padding: 10px 16px;
      z-index: 100;
      max-width: 80%;
      min-width: 300px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #eee;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: none; /* Hidden until first action result */
    }

    /* Action Menu Button */
    #action-menu-button {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1a1d23;
      border: 2px solid #333;
      color: #eee;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s;
    }
    #action-menu-button:hover {
      background: #252831;
      border-color: #555;
      transform: scale(1.05);
    }
    #action-menu-button:active {
      transform: scale(0.95);
    }

    /* AI Toggle Button */
    #ai-toggle-button {
      position: fixed;
      bottom: calc(140px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1a1d23;
      border: 2px solid #333;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s;
    }
    #ai-toggle-button.enabled {
      background: #27ae60;
      border-color: #229954;
      color: white;
      box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
    }
    #ai-toggle-button:hover {
      transform: scale(1.05);
    }
    #ai-toggle-button:active {
      transform: scale(0.95);
    }

    /* AI Speech Bubble */
    #ai-bubble {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      border: 3px solid #333;
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      z-index: 200;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -100%) translateY(-10px) scale(0.8);
      transition: opacity 0.3s, transform 0.3s;
      max-width: 200px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
    }
    #ai-bubble.show {
      display: block;
      opacity: 1;
      transform: translate(-50%, -100%) translateY(0) scale(1);
    }
    #ai-bubble::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 12px solid #333;
    }
    #ai-bubble::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid rgba(255, 255, 255, 0.95);
      z-index: 1;
    }
    #ai-bubble-emoji {
      font-size: 20px;
      margin-right: 6px;
    }

    /* Manual LLM Mode Toggle */
    #manual-mode-toggle {
      position: fixed;
      bottom: calc(200px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      background: #1a1d23;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 8px 12px;
      color: #eee;
      font-size: 12px;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    #manual-mode-toggle:hover {
      background: #252831;
      border-color: #555;
    }

    #manual-mode-toggle.active {
      background: #f39c12;
      border-color: #e67e22;
      box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
    }

    #manual-mode-checkbox {
      margin: 0;
      cursor: pointer;
    }

    /* AI Button Pulse when decision needed */
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 30px rgba(243, 156, 18, 0.8);
        transform: scale(1.1);
      }
    }

    #ai-toggle-button.decision-needed {
      animation: pulse 1.5s infinite;
      background: #f39c12;
      border-color: #e67e22;
      color: white;
    }

    /* Manual Decision Panel */
    #manual-decision-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      background: #1a1d23;
      border: 3px solid #f39c12;
      border-radius: 12px;
      z-index: 2000;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 0 50px rgba(243, 156, 18, 0.3);
    }

    #manual-decision-panel.show {
      display: flex;
    }

    #manual-decision-header {
      background: #f39c12;
      color: #1a1d23;
      padding: 12px 16px;
      font-weight: bold;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #manual-decision-close {
      background: none;
      border: none;
      color: #1a1d23;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #manual-decision-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      color: #eee;
    }

    #manual-decision-prompt {
      background: #252831;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      -webkit-user-select: text;
      user-select: text;
    }

    .manual-decision-section {
      margin-bottom: 16px;
    }

    .manual-decision-label {
      font-weight: bold;
      color: #f39c12;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .manual-decision-input,
    .manual-decision-textarea,
    .manual-decision-select {
      width: 100%;
      background: #252831;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px;
      color: #eee;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }

    .manual-decision-textarea {
      min-height: 60px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    .manual-decision-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .manual-decision-action-btn {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      background: #27ae60;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .manual-decision-action-btn:hover {
      background: #229954;
      transform: translateY(-2px);
    }

    .manual-decision-action-btn:active {
      transform: translateY(0);
    }

    #manual-execute-button {
      width: 100%;
      padding: 12px;
      background: #f39c12;
      border: none;
      border-radius: 8px;
      color: #1a1d23;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 16px;
    }

    #manual-execute-button:hover {
      background: #e67e22;
      transform: scale(1.02);
    }

    #manual-execute-button:active {
      transform: scale(0.98);
    }
  </style>
</head>

<body>
  <!-- Game Over Screen -->
  <div id="game-over-screen">
    <div id="game-over-title">üíÄ GAME OVER</div>
    <div id="game-over-message">You have died...</div>
    <button id="respawn-button">Respawn</button>
  </div>

  <!-- Needs Display (LOW IS ALWAYS BAD) -->
  <div id="needs-display">
    <div class="need-bar-container">
      <span class="need-emoji">‚ù§Ô∏è</span>
      <div class="need-bar-bg">
        <div class="need-bar-fill hp" id="hp-bar" style="width: 100%"></div>
      </div>
    </div>
    <div class="need-bar-container">
      <span class="need-emoji">üçñ</span>
      <div class="need-bar-bg">
        <div class="need-bar-fill food" id="food-bar" style="width: 100%"></div>
      </div>
    </div>
    <div class="need-bar-container">
      <span class="need-emoji">‚ö°</span>
      <div class="need-bar-bg">
        <div class="need-bar-fill energy" id="energy-bar" style="width: 100%"></div>
      </div>
    </div>
    <div class="need-bar-container">
      <span class="need-emoji">üî•</span>
      <div class="need-bar-bg">
        <div class="need-bar-fill warmth" id="warmth-bar" style="width: 100%"></div>
      </div>
    </div>
  </div>

  <!-- AI Speech Bubble -->
  <div id="ai-bubble">
    <span id="ai-bubble-emoji"></span>
    <span id="ai-bubble-text"></span>
  </div>

  <!-- AI Toggle Button -->
  <button id="ai-toggle-button" title="Toggle AI Control">ü§ñ</button>

  <!-- Manual LLM Mode Toggle -->
  <div id="manual-mode-toggle" title="Act as the LLM yourself">
    <input type="checkbox" id="manual-mode-checkbox">
    <label for="manual-mode-checkbox">Manual Mode</label>
  </div>

  <!-- Manual Decision Panel -->
  <div id="manual-decision-panel">
    <div id="manual-decision-header">
      <span>üß† You are the LLM - Make a Decision</span>
      <button id="manual-decision-close">√ó</button>
    </div>
    <div id="manual-decision-content">
      <div class="manual-decision-section">
        <div class="manual-decision-label">üìã Context & State:</div>
        <div id="manual-decision-prompt"></div>
      </div>

      <div class="manual-decision-section">
        <div class="manual-decision-label">üéØ Quick Actions:</div>
        <div class="manual-decision-buttons" id="manual-quick-actions"></div>
      </div>

      <div class="manual-decision-section">
        <div class="manual-decision-label">üí≠ Intent (goal):</div>
        <input type="text" class="manual-decision-input" id="manual-intent" placeholder="e.g., Gather food for survival">
      </div>

      <div class="manual-decision-section">
        <div class="manual-decision-label">üìù Plan (optional steps):</div>
        <textarea class="manual-decision-textarea" id="manual-plan" placeholder="e.g., Find food, collect it, eat when hungry"></textarea>
      </div>

      <div class="manual-decision-section">
        <div class="manual-decision-label">üé¨ Action:</div>
        <select class="manual-decision-select" id="manual-action"></select>
      </div>

      <div class="manual-decision-section" id="manual-args-section" style="display: none;">
        <div class="manual-decision-label">‚öôÔ∏è Arguments:</div>
        <div id="manual-args-inputs"></div>
      </div>

      <div class="manual-decision-section">
        <div class="manual-decision-label">üí¨ Speech Bubble:</div>
        <input type="text" class="manual-decision-input" id="manual-bubble-text" placeholder="What to say (‚â§8 words)">
        <input type="text" class="manual-decision-input" id="manual-bubble-emoji" placeholder="Emoji" value="üí≠" style="margin-top: 8px;">
      </div>

      <button id="manual-execute-button">Execute Decision</button>
    </div>
  </div>

  <!-- Action Menu Button -->
  <button id="action-menu-button" title="Open Action Menu">üéÆ</button>

  <!-- Action Menu -->
  <div id="action-menu">
    <div id="action-menu-title">Select Action</div>
    <div id="action-menu-list"></div>
    <button id="action-menu-close">Cancel</button>
  </div>

  <!-- Feedback Log -->
  <div id="feedback-log"></div>

  <!-- Reload button for new version detection -->
  <button id="reload-button" title="New version available! Click to reload">üîÑ</button>

  <!-- Console UI -->
  <button id="console-toggle">üêõ</button>
  <div id="console-panel">
    <div id="console-header">
      <span id="console-title">Console</span>
      <div id="console-buttons">
        <button id="console-copy">Copy All</button>
        <button id="console-clear">Clear</button>
      </div>
    </div>
    <div id="console-output"></div>
  </div>

  <!-- Auto-versioned module loader (with silent fallback) -->
  <script>
  (async () => {
    try {
      const res = await fetch('./version.txt', { cache: 'no-store' });
      const v = res.ok ? (await res.text()).trim() : String(Date.now());
      window.__BUILD = v;

      // Load main module with cache busting
      const s = document.createElement('script');
      s.type = 'module';
      s.src = `./main.js?v=${encodeURIComponent(v)}`;
      document.head.appendChild(s);
    } catch (err) {
      console.warn('version.txt missing, using fallback timestamp');
      window.__BUILD = String(Date.now());
    }
  })();
  </script>
</body>
</html>
